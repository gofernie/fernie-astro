---
import Site from "../../layouts/Site.astro";

/* slug + data helpers */
function slugify(s=""){
  return String(s).toLowerCase().trim()
    .replace(/&/g,"-and-").replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,"");
}
export async function getStaticPaths(){
  const url = import.meta.env.PUBLIC_SHEET_JSON;
  if(!url) return [];
  const res = await fetch(url);
  const data = await res.json();
  const items = data.map(n => ({...n, _slug:(n.slug?.trim() || slugify(n.title || ""))}));
  return items.filter(n=>n._slug).map(n => ({
    params: { slug: n._slug },
    props: { item: { ...n, slug:n._slug } },
  }));
}

const { item } = Astro.props;
const pageTitle = `${item.title} ‚Äî Fernie Neighbourhood`;
const description = item.desc || `About ${item.title}`;

/* image helpers */
function rawPath(img){ return img ? (img.startsWith("http") ? img : "/images/" + img) : ""; }
function cdn(url,w,h){ return `/.netlify/images?url=${encodeURIComponent(url)}&w=${w}${h?`&h=${h}&fit=cover`:"&fit=cover"}`; }
function heroSrc(url){ return import.meta.env.PROD ? cdn(url,1600,900) : url; }
function heroSrcSet(url){
  if(!import.meta.env.PROD) return undefined;
  const widths=[960,1280,1600,1920];
  return widths.map(w=>`${cdn(url,w,Math.round(w*0.5625))} ${w}w`).join(", ");
}
const raw = rawPath(item.img);
const heroW = 1600, heroH = 900;

/* pills -> array */
const pills = Array.isArray(item.pills)
  ? item.pills.filter(Boolean)
  : String(item.pills ?? "").split(",").map(s=>s.trim()).filter(Boolean);

/* quick facts content (fallbacks if not present) */
const factVibe   = item.vibe   || "Quiet, outdoorsy, family-friendly";
const factTrails = item.trails || "5+ trailheads within 10 min";
const factAccess = item.access || "7 min to Downtown, on bus route";
---

<Site title={pageTitle} description={description} active="neighbourhoods">
  {raw && <link slot="head" rel="preload" as="image" href={heroSrc(raw)} fetchpriority="high" />}

  <!-- HERO -->
  <div slot="hero" class="hero-wrap">
    <style>
      .hero-wrap { position:relative; height:55vh; }
      .hero-img  { position:absolute; inset:0; width:100%; height:100%; object-fit:cover; display:block; }
      .shade     { position:absolute; inset:0; background:linear-gradient(180deg, rgba(0,0,0,.35), rgba(0,0,0,.15)); }
      .hero-text { position:absolute; inset:0; display:flex; align-items:flex-end; }
      :root { --max: 72rem; --pad: 16px; }
      .hero-side {
        box-sizing:border-box;
        width:100%;
        padding-left:calc(max((100vw - var(--max))/2,0px) + var(--pad));
        padding-right:calc(max((100vw - var(--max))/2,0px) + var(--pad));
        padding-bottom:calc(var(--pad) * 2);
        color:#fff;
      }
      .hero-title {
        margin:0;
        font-size:clamp(28px,5vw,44px);
        line-height:1.15;
        text-shadow:0 2px 18px rgba(0,0,0,.35);
      }
    </style>

    {raw ? (
      <>
        <img class="hero-img" src={heroSrc(raw)} srcset={heroSrcSet(raw)} sizes="100vw"
             alt={item.title} width={heroW} height={heroH} fetchpriority="high" decoding="async" />
        <div class="shade"></div>
        <div class="hero-text"><div class="hero-side"><h1 class="hero-title">{item.title}</h1></div></div>
      </>
    ) : (
      <div class="hero-text"><div class="hero-side"><h1 class="hero-title">{item.title}</h1></div></div>
    )}
  </div>

  <style>
    .back {
      display:inline-block;
      margin:12px 0 16px;
      text-decoration:none;
      color:#111;
      border:1px solid #111;
      padding:8px 12px;
      border-radius:10px;
    }

    /* Card styling */
    .card {
      border: 1px solid #cbd5e1;
      border-radius: 14px;
      box-shadow: 0 4px 10px rgba(0,0,0,.08);
      background: #fff;
      margin: 24px 0;
      overflow: hidden;
    }
    .card h2 {
      margin: 0;
      padding: 16px;
      border-bottom: 1px solid #e5e7eb;
      font-size: 18px;
      color: #334155;
    }
    .card-body { padding: 16px; }

    .pills {
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin:0 0 12px;
    }
    .pill {
      border:1px solid #ddd;
      border-radius:999px;
      padding:4px 10px;
      font-size:12px;
      color:#444;
      background:#fff;
    }
    .content :where(h2,h3){margin-top:1.2em}

    /* Quick Facts (3-up) */
    .facts{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:14px;margin:24px 0}
    .fact{display:flex;gap:12px;align-items:flex-start;border:1px solid #e5e7eb;border-radius:14px;background:#fff;
          box-shadow:0 2px 8px rgba(0,0,0,.06);padding:14px}
    .fact h3{margin:0 0 2px;font-size:14px;color:#0f172a}
    .fact p{margin:0;color:#475569;font-size:13px}
    .ico{font-size:20px;line-height:1}
    @media (max-width:820px){ .facts{grid-template-columns:1fr} }
  </style>

  <a class="back" href="/neighbourhoods">‚Üê Back to neighbourhoods</a>

  <!-- QUICK FACTS -->
  <section class="facts" aria-label="Quick facts">
    <article class="fact"><div class="ico">üèîÔ∏è</div><div><h3>Vibe</h3><p>{factVibe}</p></div></article>
    <article class="fact"><div class="ico">üö≤</div><div><h3>Trails</h3><p>{factTrails}</p></div></article>
    <article class="fact"><div class="ico">üöå</div><div><h3>Access</h3><p>{factAccess}</p></div></article>
  </section>

  <!-- CARD WITH PILLS + DESC -->
  <section class="card" aria-labelledby="desc-title">
    <h2 id="desc-title">{item.title} Overview</h2>
    <div class="card-body">
      {pills.length > 0 && (
        <div class="pills" aria-label="Highlights">
          {pills.map(p => <span class="pill">{p}</span>)}
        </div>
      )}
      <p>{item.desc}</p>
    </div>
  </section>

  <!-- OPTIONAL ABOUT CARD (only renders if about has content) -->
  {item.about && (
    <section class="card" aria-labelledby="about-title">
      <h2 id="about-title">About {item.title}</h2>
      <div class="card-body">
        <section class="content" set:html={item.about}></section>
      </div>
    </section>
  )}

  <!-- OPTIONAL MAP CARD (only if item.map provided) -->
  {item.map && (
    <section class="card" aria-labelledby="map-title">
      <h2 id="map-title">Map</h2>
      <div class="card-body">
        <iframe
          src={item.map}
          loading="lazy"
          width="100%" height="320"
          style="border:0;border-radius:12px;"
          allowfullscreen
          referrerpolicy="no-referrer-when-downgrade"></iframe>
      </div>
    </section>
  )}
</Site>
