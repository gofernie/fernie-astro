---
import Site from "../../layouts/Site.astro";

/* slug + data helpers */
function slugify(s=""){
  return String(s).toLowerCase().trim()
    .replace(/&/g,"-and-").replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,"");
}
export async function getStaticPaths(){
  const url = import.meta.env.PUBLIC_SHEET_JSON;
  if(!url) return [];
  const res = await fetch(url);
  const data = await res.json();
  const items = data.map(n => ({...n, _slug:(n.slug?.trim() || slugify(n.title || ""))}));
  return items.filter(n=>n._slug).map(n => ({
    params: { slug: n._slug },
    props: { item: { ...n, slug:n._slug } },
  }));
}

const { item } = Astro.props;
const pageTitle = `${item.title} — Fernie Neighbourhood`;
const description = item.desc || `About ${item.title}`;

/* image helpers */
function rawPath(img){ return img ? (img.startsWith("http") ? img : "/images/" + img) : ""; }
function cdn(url,w,h){ return `/.netlify/images?url=${encodeURIComponent(url)}&w=${w}${h?`&h=${h}&fit=cover`:"&fit=cover"}`; }
function heroSrc(url){ return import.meta.env.PROD ? cdn(url,1600,900) : url; }
function heroSrcSet(url){
  if(!import.meta.env.PROD) return undefined;
  const widths=[960,1280,1600,1920];
  return widths.map(w=>`${cdn(url,w,Math.round(w*0.5625))} ${w}w`).join(", ");
}
const raw = rawPath(item.img);
const heroW = 1600, heroH = 900;

/* pills -> array */
const pills = Array.isArray(item.pills)
  ? item.pills.filter(Boolean)
  : String(item.pills ?? "").split(",").map(s=>s.trim()).filter(Boolean);
---
<Site title={pageTitle} description={description} active="neighbourhoods">
  {raw && <link slot="head" rel="preload" as="image" href={heroSrc(raw)} fetchpriority="high" />}

  <!-- 55vh hero with overlay title aligned to header/logo -->
  <div slot="hero" class="hero-wrap">
    <style>
      .hero-wrap { position:relative; height:55vh; }
      .hero-img  { position:absolute; inset:0; width:100%; height:100%; object-fit:cover; display:block; }
      .shade     { position:absolute; inset:0; background:linear-gradient(180deg, rgba(0,0,0,.35), rgba(0,0,0,.15)); }

      .hero-text { position:absolute; inset:0; display:flex; align-items:flex-end; }

      /* Align to SAME left/right as the header/logo container */
      :root { /* ensure these exist in Site.astro too */
        --max: 72rem;
        --pad: 16px;
      }
      .hero-side {
        box-sizing: border-box;
        width: 100%;
        /* container math: centered max + gutters */
        padding-left:  calc(max((100vw - var(--max)) / 2, 0px) + var(--pad));
        padding-right: calc(max((100vw - var(--max)) / 2, 0px) + var(--pad));
        padding-bottom: calc(var(--pad) * 2);
        color:#fff;
      }
      .hero-title { margin:0; font-size:clamp(28px,5vw,44px); line-height:1.15; text-shadow:0 2px 18px rgba(0,0,0,.35); }
    </style>

    {raw ? (
      <>
        <img
          class="hero-img"
          src={heroSrc(raw)}
          srcset={heroSrcSet(raw)}
          sizes="100vw"
          alt={item.title}
          width={heroW} height={heroH}
          fetchpriority="high"
          decoding="async"
        />
        <div class="shade"></div>
        <div class="hero-text">
          <div class="hero-side">
            <h1 class="hero-title">{item.title}</h1>
          </div>
        </div>
      </>
    ) : (
      <div class="hero-text">
        <div class="hero-side">
          <h1 class="hero-title">{item.title}</h1>
        </div>
      </div>
    )}
  </div>

  <style>
    .lede{color:#444;margin:8px 0 16px}
    .back{display:inline-block;margin:12px 0 16px;text-decoration:none;color:#111;border:1px solid #111;padding:8px 12px;border-radius:10px}

    .pills{display:flex;gap:8px;flex-wrap:wrap;margin:0 0 16px}
    .pill{border:1px solid #ddd;border-radius:999px;padding:4px 10px;font-size:12px;color:#444;background:#fff}

    .card{border:1px solid #eee;border-radius:14px;box-shadow:0 1px 2px rgba(0,0,0,.04);background:#fff;overflow:hidden}
    .card h2{margin:0;padding:16px;border-bottom:1px solid #eee;font-size:18px;color:#6b7280;}
    .card-body{padding:16px}

    .content :where(h2,h3){margin-top:1.2em}
  </style>

  <a class="back" href="/neighbourhoods">← Back to neighbourhoods</a>

  {pills.length > 0 && (
    <div class="pills" aria-label="Highlights">
      {pills.map(p => <span class="pill">{p}</span>)}
    </div>
  )}

  {item.desc && <p class="lede">{item.desc}</p>}

  <section class="card" aria-labelledby="about-title">
    <h2 id="about-title">About {item.title} Neighbourhood</h2>
    <div class="card-body">
      <section class="content" set:html={item.about}></section>
    </div>
  </section>
</Site>
